<!doctype html>
<html lang="en" data-color-mode="auto">
 <meta charset="utf-8">
 <head>
 <link rel="stylesheet" href="3rdparty/markdown_themes/markdown.css">
 <link rel="stylesheet" href="3rdparty/markdown_themes/{markdown_theme}/{markdown_theme}.css">
 <link rel="stylesheet" href="{scroll_bar_theme}.css">
 <script src="3rdparty/marked.js"></script>
 <script src="qrc:/qtwebchannel/qwebchannel.js"></script>

 <script src="3rdparty/highlight/highlight.pack.js"></script>
 <link rel="stylesheet" href="3rdparty/highlight/styles/{highlight_theme}.css">
 <style type="text/css">

  body {
      overflow-x:hidden;
  }
  </style>

 </head>
 <body>
  <div id="placeholder" class="markdown {markdown_theme}"></div>
  <script>
    'use strict';
    var lineNumbers = [];
    var placeholder = document.getElementById('placeholder');

    var searchEqualOrLessMaximum = function (array, item) {
        let lo = -1, hi = array.length;
        while (1 + lo < hi) {
            const mi = lo + ((hi - lo) >> 1);
            if (array[mi] > item) {
                hi = mi;
            } else {
                lo = mi;
            }
        }
        if(array[hi]==item){
            return array[hi];
        }else{
            return array[hi-1];
        }
    }
    var updateText = function(text,path) {
        lineNumbers = [];
        placeholder.innerHTML = marked(text, {baseUrl : 'file:////' + (!path.endsWith('/')? path + '/' : path)}, null, lineNumbers);
        document.querySelectorAll('pre code').forEach(block => {hljs.highlightBlock(block);});
    }

    var scrollToLine = function(lineNumber) {
        if(lineNumbers.length > 0){
            const matches = document.querySelectorAll("*[dl='" + searchEqualOrLessMaximum(lineNumbers, lineNumber) + "']");
            if(matches.length > 0){
                matches[0].scrollIntoView(true);
            }
        }
    }

    new QWebChannel(qt.webChannelTransport,
      function(channel) {
         window.mediator = channel.objects.mediator;
         var mediator = channel.objects.mediator;
         mediator.textChanged.connect(updateText);
         mediator.firstLineNumberInEditorChanged.connect(scrollToLine);
         mediator.pageLoaded();
      }
    );

  </script>
 </body>
</html>
