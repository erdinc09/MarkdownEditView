<!doctype html>
<html lang="en" data-color-mode="auto">
<meta charset="utf-8">

<head>
    <link rel="stylesheet" href="3rdparty/markdown_themes/markdown.css">
    <link rel="stylesheet" href="3rdparty/markdown_themes/{markdown_theme}/{markdown_theme}.css">
    <link rel="stylesheet" href="{scroll_bar_theme}.css">
    <script src="3rdparty/marked.js"></script>
    <script src="qrc:/qtwebchannel/qwebchannel.js"></script>
    <script src="3rdparty/highlight/highlight.pack.js"></script>

    <link rel="stylesheet" href="3rdparty/highlight/styles/{highlight_theme}.css">
    <style type="text/css">
        body {
            overflow-x: hidden;
        }
    </style>

</head>

<body>
    <div id="placeholder" class="markdown {markdown_theme}"></div>
    <script>
        'use strict';
        var placeholder = document.getElementById('placeholder');
        var updateText = function (text, path) {
            placeholder.innerHTML = marked(
                text,
                {
                    baseUrl: 'file:////' + (!path.endsWith('/') ? path + '/' : path),
                    highlight: function (code, language) {
                        const validLanguage = hljs.getLanguage(language) ? language : 'plaintext';
                        return hljs.highlight(validLanguage, code).value;
                    }
                },
                null);
        }


        var scrollToLine = function (lineNumber) {
            const matches = document.querySelectorAll(`*[dl~='${lineNumber}']`);
            if (matches.length > 0) {
                let elem = matches[0];
                elem.scrollIntoView(true);
                if (elem.tagName.toLowerCase() === 'code') {
                    let lineNumbers = elem.getAttribute('dl');
                    let lines = lineNumbers.split(' ');
                    if (elem.getAttribute('fence') === 'true') {
                        lines = lines.slice(1, lines.length - 1);
                    }
                    let yScroll = elem.scrollHeight * ((lineNumber - parseFloat(lines[0])) / parseFloat(lines.length));
                    window.scrollBy(0, yScroll);
                }
            }
        }

        document.addEventListener('scroll', function (e) {
            for (let elem of document.querySelectorAll('*[dl]')) {
                let clientRect = elem.getBoundingClientRect();
                if (clientRect.bottom >= 0) {
                    let dlAttr = elem.getAttribute('dl');
                    let lineNumber = elem.tagName.toLowerCase() === 'code' ? dlAttr.split(' ')[0] : dlAttr;
                    //TODO:emulate code & fence !
                    mediator.firstLineNumberInPreviewChanged(lineNumber);
                    break;
                }
            }
        });

        var mediator; //goes into global object window ...
        new QWebChannel(qt.webChannelTransport,
            function (channel) {
                mediator = channel.objects.mediator;
                mediator.textChanged.connect(updateText);
                mediator.firstLineNumberInEditorChanged.connect(scrollToLine);
                mediator.pageLoaded();
            }
        );

    </script>
</body>

</html>